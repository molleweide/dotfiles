#!/usr/bin/env bash

# TODO
#
#   add KE_Complx so that this part is done.
#   create a tmuxinator session that makes this
#   dev really simple and easy.
#
#   fork spoon and hyperkey

source "${BASH_SOURCE%/*}/shared.sh"

require_installer package-manager

dotheader "Setting up Hammerspoon..."
brew_cask_install hammerspoon --appdir=/Applications

function setup_development_spoon_from_git_repo() {
  local name=$1
  local code_dir=$HOME/code
  local source_dir=$code_dir/$name.spoon
  local symlink_destination=$HOME/.hammerspoon/Spoons/$name.spoon

  mkdir -p "$code_dir"

  if [ ! -d $source_dir ]; then
    dotsay "@blue@b[[+ cloning development copy of $name.spoon ]]"
    git clone https://github.com/dbalatero/$name.spoon "$source_dir"
  else
    dotsay "+ $name.spoon dev copy already checked out"
  fi

  if [ ! -d $symlink_destination ]; then
    dotsay "@blue@b[[+ symlinking development copy of $name.spoon ]]"
    ln -s "$source_dir" "$symlink_destination"
  else
    dotsay "+ $name.spoon already installed to Hammerspoon"
  fi
}

function setup_spoon_install() {
  local url="https://github.com/Hammerspoon/Spoons/raw/master/Spoons/SpoonInstall.spoon.zip"
  local destination=/tmp/SpoonInstall.spoon.zip
  local spoons_dir=$HOME/.hammerspoon/Spoons

  if [ ! -d "$spoons_dir/SpoonInstall.spoon" ]; then
    dotsay "@blue@b[[+ installing SpoonInstall.spoon ]]"

    wget -nv $url -O $destination
    unzip -d $spoons_dir $destination
  else
    dotsay "+ SpoonInstall.spoon already setup"
  fi
}

function setup_karabiner_dev() {
  local name=$1
  local code_dir=$HOME/code
  local source_dir=$code_dir/$name.spoon
  local symlink_destination=$HOME/.hammerspoon/Spoons/$name.spoon
  local url="https://github.com/Hammerspoon/Spoons/raw/master/Spoons/SpoonInstall.spoon.zip"
  local destination=/tmp/SpoonInstall.spoon.zip
  local spoons_dir=$HOME/.hammerspoon/Spoons

  if [ ! -d "$spoons_dir/SpoonInstall.spoon" ]; then
    dotsay "@blue@b[[+ installing SpoonInstall.spoon ]]"
    # wget -nv $url -O $destination
    # unzip -d $spoons_dir $destination
  else
    dotsay "+ SpoonInstall.spoon already setup"
  fi
}

symlink_dotfile bin/dnd-toggle ~/.local/bin/dnd-toggle

brew_install lua
brew_install luarocks

# bluetooth
brew_install blueutil

brew_cask_install karabiner-elements
symlink_dotfile karabiner ~/.config/karabiner

luarocks install loop
luarocks install dkjson
luarocks install inspect
luarocks install --server=http://luarocks.org/dev lua-lsp
luarocks install luacheck
luarocks install lcf

symlink_dotfile hammerspoon ~/.hammerspoon
setup_spoon_install
setup_development_spoon_from_git_repo HyperKey
setup_development_spoon_from_git_repo VimMode
